<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ceres Naturals – Order Request Form</title>

  <!-- ================================
       BASE STYLES
       ================================ -->
  <style>
    /* Layout / typography */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #222;
    }

    .wrapper {
      max-width: 1400px;
      width: min(96vw, 1400px);
      margin: 40px auto;
      padding: 20px 24px 40px;
      background: #fff;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      border-radius: 8px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 26px;
    }

    .subtitle {
      margin: 0 0 24px;
      font-size: 14px;
      color: #555;
    }

    /* Required fields (top form) */
    .required-fields {
      display: flex;
      flex-wrap: wrap;
      gap: 16px 32px;
      margin-bottom: 24px;
    }

    .required-fields .readonly-text {
      width: 260px;
      max-width: 100%;
    }

    .required-fields label {
      display: flex;
      flex-direction: column;
      font-weight: 600;
      font-size: 14px;
    }

    .required-fields input {
      margin-top: 4px;
      width: 260px;
      max-width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
      outline: none;
    }

    .required-fields input:focus {
      border-color: #0070c9;
      box-shadow: 0 0 0 2px rgba(0, 112, 201, 0.15);
    }

    .helper-text {
      margin-top: 6px;
      font-size: 12px;
      color: #666;
    }

    .readonly-text {
      margin-top: 4px;
      min-height: 38px;
      padding: 8px 0;
      width: 260px;

      background: transparent;
      border: none;

      font-size: 14px;
      color: #333;
    }


    /* Menu controls (in-stock toggle) */
    .menu-controls {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 16px;
      margin: 8px 0 8px;
      font-size: 13px;
      color: #333;
    }

    .menu-controls label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
    }

    /* Container for all menu tables (scroll if wide) */
    #menu-data {
      overflow-x: auto;
      margin-top: 10px;
    }

    /* Running total display */
    #running-total {
      font-size: 18px;
      font-weight: 700;
      margin: 18px 0;
      text-align: right;
    }

    /* Notes area */
    #special-notes {
      width: 100%;
      max-width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
      resize: vertical;
      min-height: 80px;
    }

    /* Submit button */
    .submit-row {
      text-align: right;
      margin-top: 24px;
    }

    .submit-row button {
      position: relative;
      z-index: 1;
      display: inline-block;
      padding: 10px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #0070c9;
      color: #fff;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.1s ease;
    }

    .submit-row button:hover {
      background: #005fa8;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }

    .submit-row button:active {
      background: #004c86;
      box-shadow: none;
      transform: translateY(0);
    }

    /* Section headings for product groups */
    .group-title {
      margin: 26px 0 4px;
      font-size: 20px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
    }

    .group-description {
      margin: 0 0 10px 4px;
      font-size: 13px;
      color: #555;
    }

    .subgroup-title {
      margin: 12px 0 2px 4px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .subgroup-sample-toggle {
      font-size: 12px;
      font-weight: 400;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      user-select: none;
    }

    .subgroup-sample-toggle input[type="checkbox"] {
      transform: scale(1.05);
    }

    .subgroup-description {
      margin: 0 0 8px 4px;
      font-size: 13px;
      color: #666;
    }

    .blend-description {
      margin: 0 0 8px 4px;
      font-size: 13px;
      color: #666;
      font-style: italic;
    }

    /* Table styles */
    table.menu-table {
      border-collapse: collapse;
      width: 100%;
      min-width: 1200px;
      margin: 0 0 20px;
      font-size: 14px;
      table-layout: fixed;
      background: #fff;
    }

    table.menu-table th,
    table.menu-table td {
      border: 1px solid #333;
      padding: 8px 10px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    table.menu-table thead tr {
      background: #f2f2f2;
    }

    table.menu-table tbody tr:nth-child(odd) {
      background: #fafafa;
    }

    table.menu-table tbody tr:nth-child(even) {
      background: #fff;
    }

    /* Sortable headers (data-sort-col) */
    th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .sort-label {
      display: inline-block;
      padding-right: 12px;
    }

    .sort-indicator {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      opacity: 0.5;
    }

    th.sortable[data-sort-active="true"] .sort-indicator {
      opacity: 1;
    }

    /* Price & quantity inputs */
    .item-price {
      font-variant-numeric: tabular-nums;
    }

    .item-total {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }

    .item-input {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
      text-align: center;
      font-size: 14px;
    }

    /* Sold-out row */
    .sold-out-row td {
      text-align: center;
      font-style: italic;
      color: #666;
    }

    .suggestion {
      padding: 8px 10px;
      cursor: pointer;
    }

    .suggestion:hover {
      background: #f0f0f0;
    }

.autocomplete {
  position: relative;
}

.suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  background: #fff;
  border: 1px solid #ccc;
  max-height: 220px;
  overflow-y: auto;
  width: 100%;
  z-index: 1000;
  display: none;
}

  </style>
</head>
<body>
  <div class="wrapper" id="app-wrapper">

    <!-- ================================
         HEADER
         ================================ -->
    <header>
      <h1>Order Request Form</h1>
      <p class="subtitle">
        Please fill in your contact and license information, then enter quantities in the menu below.
        Quantities are rounded to the nearest multiple of 5. Use the “Sample Request” toggle next to a product type
        (e.g., Zen Drops, Diamond Cut) if you’d like samples of that kind of product.
      </p>
    </header>

    <!-- ================================
         REQUIRED INPUTS
         ================================ -->
    <section class="top-form">
      <div class="required-fields">
        <label>
          Delivery License #:
          <div class="autocomplete">
            <input id="delivery-license" type="text" autocomplete="off" required>
            <div id="license-suggestions" class="suggestions"></div>
          </div>
        </label>
        <label>
          Dispensary Name:
          <div class="autocomplete">
            <input id="dispensary-name" type="text" autocomplete="off" required>
            <div id="dispensary-suggestions" class="suggestions"></div>
          </div>
        </label>
        <label>
          Contact Name:
          <input id="user-name" type="text" required>
        </label>
        <label>
          Badge Number:
          <input id="badge-number" type="text" required>
        </label>       
        <label>
          Contact Email:
          <input id="contact-email" type="email" required>
        </label>
        <label>
          Business Name:
          <div id="business-name-display" class="readonly-text"></div>
        </label>
        <input type="hidden" id="business-name">
      </div>
      <p class="helper-text">
        All fields above are required before submitting an order request.
      </p>
    </section>

    <!-- ================================
         MENU TABLES + RUNNING TOTAL
         ================================ -->
    <section>
      <div id="menu-data">
        <!-- Tables are injected here by JavaScript -->
      </div>
      <div id="running-total">Total: $0.00</div>
    </section>

    <!-- ================================
         OPTIONAL NOTES
         ================================ -->
    <section>
      <label for="special-notes"><strong>Special Instructions (optional):</strong></label><br>
      <textarea id="special-notes" rows="4" placeholder="Delivery instructions, blackout times, sample notes, etc."></textarea>
    </section>

    <!-- ================================
         SUBMIT BUTTON
         ================================ -->
    <section class="submit-row">
      <button type="button" id="submit-button">Submit Order Request</button>
    </section>
  </div>

  <!-- ================================
       EMAILJS SDK
       ================================ -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <!-- ================================
       MAIN SCRIPT
       ================================ -->
  <script>
    // =====================================
    // CONSTANTS & GLOBAL STATE
    // =====================================

    // Menu data source (GitHub JSON)
    const DATA_URL = 'https://raw.githubusercontent.com/Ceresnaturals/live-menu/main/menu.json';

    //Autofill Source License Info
    const LICENSES_URL = 'https://raw.githubusercontent.com/Ceresnaturals/live-menu/main/licenses.json';

    let licenses = [];

    fetch(LICENSES_URL)
      .then(r => r.json())
      .then(data => {
        licenses = Array.isArray(data) ? data : [];
        console.log('Licenses loaded:', licenses.length);
      })
      .catch(err => {
        console.error('Failed to load licenses.json', err);
      });


    // In-memory merged packages array
    let packages = [];

    // Tincture potency reference (mg/15 mL bottle) – for future use
    const tincturePotencies = {
      'Zen Drops':   { THC: 75, CBD: 75, CBN: 75 },
      'Lucid Drops': { THC: 75, CBD: 75, THCV: 37.5, CBC: 18.75 },
      'Drift Drops': { CBN: 150, THC: 75, CBD: 75, CBG: 37.5 },
      'Pure Drops':  { THC: 75 }
    };

    // Group descriptions (top-level)
    const groupDescriptions = {
      'Tincture': 'Full-spectrum - water soluble tinctures formulated for specific effects and dosing precision.',
      'Infused Pre-Rolls': 'Premium infused pre-rolls crafted for potency and consistency.',
      'Pre-Roll': 'Classic single-strain pre-rolls with smooth burn and true flavor.',
      'Cart': 'High-quality distillate cartridges available in multiple sizes.',
      'Vape': 'Disposable all-in-one vapor products in standard and large formats.',
      'Other': 'Limited-run and specialty products.'
    };

    // Subgroup descriptions
    const subgroupDescriptions = {
      'Zen Drops': 'Balanced 1:1:1 blend of THC, CBD, and CBN - for calm and clarity.',
      'Lucid Drops': 'THC, CBD, THCV, and CBC for focus and creative clarity.',
      'Drift Drops': 'CBN-rich nighttime tincture with supporting cannabinoids.',
      'Pure Drops': 'Single-compound THC tincture for micro-dosing simplicity.',
      'Diamond Cut': 'Flagship diamond-infused pre-roll — potent and flavorful.',
      'Double Diamonds': 'Diamond-infused inside, Diamond-coated outside for maximum strength.',
      '1 gram': 'Standard size for consistent potency.',
      '2 gram': 'High-capacity format for extended use.'
    };

    // Static description of tincture blends
    const tinctureBlends = [
      {
        name: 'Zen Drops',
        blend: '75mg THC + 75mg CBD + 75mg CBN per 15 mL bottle'
      },
      {
        name: 'Lucid Drops',
        blend: '75mg THC + 75mg CBD + 37.5mg THCV + 18.75mg CBC per 15 mL bottle'
      },
      {
        name: 'Drift Drops',
        blend: '150mg CBN + 75mg THC + 75mg CBD + 37.5mg CBG per 15 mL bottle'
      },
      {
        name: 'Pure Drops',
        blend: '75mg THC per 15 mL bottle'
      }
    ];

    // Standard colgroup for non-tincture tables (9 columns)
    const standardColgroup = `
      <col style="width:420px"> <!-- Item -->
      <col style="width:140px"> <!-- Category -->
      <col style="width:110px"> <!-- Avail. Qty -->
      <col style="width:110px"> <!-- Price -->
      <col style="width:90px">  <!-- THC % -->
      <col style="width:90px">  <!-- CBD % -->
      <col style="width:95px">  <!-- Terps % -->
      <col style="width:150px"> <!-- Amount Wanted -->
      <col style="width:140px"> <!-- Item Total -->
    `;

    // Tincture colgroup (6 columns)
    const tinctureColgroup = `
      <col style="width:420px"> <!-- Item -->
      <col style="width:140px"> <!-- Category -->
      <col style="width:110px"> <!-- Avail. Qty -->
      <col style="width:110px"> <!-- Price -->
      <col style="width:150px"> <!-- Amount Wanted -->
      <col style="width:140px"> <!-- Item Total -->
    `;

    // =====================================
    // EMAILJS INITIALIZATION
    // =====================================
    emailjs.init("YJxuLBBU1UI_Cd0dJ");

    // =====================================
    // MENU LOAD & INITIAL RENDER
    // =====================================

    // =====================================
    // Fetch menu JSON, merge packages by ItemName, then render grouped tables
    // =====================================    
    fetch(DATA_URL)
      .then(r => r.json())
      .then(data => {
        const rawPackages = Array.isArray(data) ? data : [];
        packages = mergePackagesByItemName(rawPackages);

        if (!packages.length) {
          document.getElementById('menu-data').textContent = 'No menu items available.';
          return;
        }

        renderMenuTables();
        updateTotals();
      })
      .catch(err => {
        console.error('Failed to load menu data:', err);
        document.getElementById('menu-data').textContent = 'Error loading menu.';
      });

    // =====================================
    // DATA MERGE & ANALYTE CALCULATION
    // =====================================

    /**
     * Merge raw packages by ItemName.
     * - Sums quantities across all packages with the same name.
     * - Keeps lab results and metadata from the oldest batch.
     * - Precomputes analytes on the merged object.
     */
    function mergePackagesByItemName(rawPackages) {
      const groupedMap = new Map();

      rawPackages.forEach(pkg => {
        const name = (pkg.ItemName || '').trim();
        if (!name) return;

        const date = new Date(
          pkg.DateReceived ||
          pkg.PackageDate ||
          pkg.CreatedAt ||
          0
        );

        const withDate = { ...pkg, _date: date };

        if (!groupedMap.has(name)) {
          groupedMap.set(name, [withDate]);
        } else {
          groupedMap.get(name).push(withDate);
        }
      });

      const merged = [];

      groupedMap.forEach(group => {
        // Sort ascending: oldest first
        group.sort((a, b) => a._date - b._date);
        const [oldest] = group;
        const totalQty = group.reduce((sum, p) => sum + (parseFloat(p.Quantity) || 0), 0);

        // Attach analyte summary once (memoized)
        const analytes = analyzeLabResults(oldest);

        merged.push({
          ...oldest,
          Quantity: totalQty,
          analytes
        });
      });

      return merged;
    }

    /**
     * Analyze lab results for a package and compute:
     * - totalTHC (THC + 0.877 * THCa)
     * - totalCBD
     * - totalTerpenes (sum of known terpene tests)
     */
    function analyzeLabResults(pkg) {
      const results = (pkg.LabResults || []).filter(r =>
        !/stability/i.test(r.TestTypeName || '')
      );

      let thc = 0, thca = 0, cbd = 0, terps = 0;

      results.forEach(r => {
        const name = String(r.TestTypeName || '').toLowerCase();
        const val = parseFloat(r.TestResultLevel) || 0;

        if (name.includes('delta-9 thc')) {
          thc = val;
        } else if (name.includes('thca')) {
          thca = val;
        } else if (name.includes('cbd')) {
          cbd += val;
        } else if (/(pinene|myrcene|limonene|linalool|caryophyllene|humulene|terpinene|terpinolene|nerolidol|camphene|eucalyptol|fenchol|isopulegol|camphor|bisabolol|ocimene|sabinene|cymene)/.test(name)) {
          terps += val;
        }
      });

      const totalTHC = +(thc + thca * 0.877).toFixed(2);
      const totalCBD = +cbd.toFixed(2);
      const totalTerpenes = +terps.toFixed(2);

      return { totalTHC, totalCBD, totalTerpenes };
    }

    // =====================================
    // FILTERING & GROUPING LOGIC
    // =====================================

    /**
     * Classify packages into display groups/subgroups based on ItemName text.
     * Returns a structure:
     * {
     *   Tincture: { 'Zen Drops': [...], ... },
     *   'Infused Pre-Rolls': { 'Diamond Cut': [...], ... },
     *   'Pre-Roll': [...],
     *   Cart: { '1 gram': [...], '2 gram': [...] },
     *   Vape: { '1 gram': [...], '2 gram': [...] },
     *   Other: [...]
     * }
     */
    function groupPackagesForDisplay(pkgArray) {
      const groups = {
        Tincture: { 'Zen Drops': [], 'Drift Drops': [], 'Lucid Drops': [], 'Pure Drops': [] },
        'Infused Pre-Rolls': { 'Diamond Cut': [], 'Double Diamonds': [] },
        'Pre-Roll': [],
        Cart: { '1 gram': [], '2 gram': [] },
        Vape: { '1 gram': [], '2 gram': [] },
        Other: []
      };

      pkgArray.forEach(pkg => {
        const name = String(pkg.ItemName || '').toLowerCase();

        // Tinctures
        if (name.includes('drops')) {
          if (name.includes('zen')) {
            groups.Tincture['Zen Drops'].push(pkg);
          } else if (name.includes('drift')) {
            groups.Tincture['Drift Drops'].push(pkg);
          } else if (name.includes('lucid')) {
            groups.Tincture['Lucid Drops'].push(pkg);
          } else if (name.includes('pure')) {
            groups.Tincture['Pure Drops'].push(pkg);
          } else {
            groups.Other.push(pkg);
          }
          return;
        }

        // Pre-rolls / infused pre-rolls
        if (
          name.includes('pre-roll') ||
          name.includes('preroll') ||
          name.includes('pr ') ||
          name.includes('double diamonds')
        ) {
          if (name.includes('double diamonds')) {
            groups['Infused Pre-Rolls']['Double Diamonds'].push(pkg);
          } else if (name.includes('lore infused pr')) {
            groups['Infused Pre-Rolls']['Diamond Cut'].push(pkg);
          } else {
            groups['Pre-Roll'].push(pkg);
          }
          return;
        }

        // Carts
        if (name.includes('cart')) {
          if (name.includes('2g') || name.includes('2 g')) {
            groups.Cart['2 gram'].push(pkg);
          } else {
            groups.Cart['1 gram'].push(pkg);
          }
          return;
        }

        // Vapes
        if (name.includes('vape')) {
          if (name.includes('2g') || name.includes('2 g')) {
            groups.Vape['2 gram'].push(pkg);
          } else {
            groups.Vape['1 gram'].push(pkg);
          }
          return;
        }

        // Fallback
        groups.Other.push(pkg);
      });

      return groups;
    }

    // =====================================
    // RENDERING FUNCTIONS
    // =====================================

    /**
     * Render all groups/subgroups into #menu-data using current sortState.
     */
    function renderMenuTables() {
      const menuContainer = document.getElementById('menu-data');
      const filtered = packages.slice();
      const grouped = groupPackagesForDisplay(filtered);
      let html = '';

      // Tinctures (custom layout with subgroup sample toggles)
      html += renderTinctureSection(grouped.Tincture);

      // Infused Pre-Rolls (subgroups with sample toggles)
      html += renderSubgroupSection('Infused Pre-Rolls', grouped['Infused Pre-Rolls'], true);

      // Cart (subgroups with sample toggles)
      html += renderSubgroupSection('Cart', grouped.Cart, true);

      // Vape (subgroups with sample toggles)
      html += renderSubgroupSection('Vape', grouped.Vape, true);

      // Pre-Roll (flat, no sample toggle)
      html += renderFlatSection('Pre-Roll', grouped['Pre-Roll']);

      // Other (flat, no sample toggle)
      html += renderFlatSection('Other', grouped.Other);

      if (!html) {
        menuContainer.innerHTML = '<p>No items match the current filters.</p>';
      } else {
        menuContainer.innerHTML = html;
      }

      updateTotals();
    }

    /**
     * Build HTML for the tincture section (blends).
     * Each blend has its own inline Sample Request checkbox on the subgroup header.
     */
    function renderTinctureSection(tinctureGroups) {
      let out = '';

      out += `
        <h2 class="group-title">Tinctures</h2>
        <p class="group-description">${groupDescriptions['Tincture'] || ''}</p>
      `;

      tinctureBlends
        .filter(b => !["Lucid Drops", "Drift Drops", "Pure Drops"].includes(b.name))
        .forEach(blend => {
          const subItems = tinctureGroups[blend.name] || [];
          const subDesc = subgroupDescriptions[blend.name] || '';
          let rowsHtml = '';

          if (!subItems.length) {
            rowsHtml = `
              <tr class="sold-out-row">
                <td colspan="6">SOLD OUT — please contact for pre-orders.</td>
              </tr>
            `;
          } else {
            rowsHtml = subItems.map(pkg => {
              const priceNum = Number(pkg.Price) || 0;
              return `
                <tr class="menu-row">
                  <td class="item-name">${pkg.ItemName || blend.name}</td>
                  <td class="item-category">${pkg.Type || 'Hybrid'}</td>
                  <td>${pkg.Quantity || 0}</td>
                  <td class="item-price" data-price="${priceNum.toFixed(2)}">$${priceNum.toFixed(2)}</td>
                  <td>
                    <input type="number"
                           min="0"
                           step="5"
                           inputmode="numeric"
                           pattern="\\d*"
                           class="item-input"
                           data-step="5">
                  </td>
                  <td class="item-total">$0.00</td>
                </tr>
              `;
            }).join('');
          }

          out += `
            <h3 class="subgroup-title">
              ${blend.name.toUpperCase()}
              <label class="subgroup-sample-toggle">
                <input type="checkbox"
                       class="subgroup-sample-checkbox"
                       data-group="Tincture"
                       data-subgroup="${blend.name}">
                Request Sample
              </label>
            </h3>
            <p class="subgroup-description">${subDesc}</p>
            <p class="blend-description">${blend.blend}</p>
            <table class="menu-table">
              <colgroup>${tinctureColgroup}</colgroup>
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Category</th>
                  <th>Avail. Qty</th>
                  <th>Price</th>
                  <th>Amount Wanted</th>
                  <th>Item Total</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          `;
        });

      return out;
    }

    /**
     * Build HTML for sections with subgroups (Infused Pre-Rolls, Cart, Vape).
     * If withSampleToggle = true, each subgroup header gets a Sample Request checkbox.
     */
    function renderSubgroupSection(groupName, groupObj, withSampleToggle) {
    if (!groupObj) return '';

    // DISPLAY LABEL ONLY (presentation layer)
    const displayName =
        groupName === 'Cart' ? 'Carts' :
        groupName === 'Vape' ? 'Vapes' :
        groupName === 'Pre-Roll' ? 'Pre-Rolls' :
        groupName;

    let out = '';

    out += `
        <h2 class="group-title">${displayName}</h2>
        <p class="group-description">${groupDescriptions[groupName] || ''}</p>
    `;


      Object.entries(groupObj).forEach(([subName, items]) => {
        const subDesc = subgroupDescriptions[subName] || '';

        let rowsHtml = '';
        if (!items.length) {
          rowsHtml = `
            <tr class="sold-out-row">
              <td colspan="9">SOLD OUT — please contact for pre-orders.</td>
            </tr>
          `;
        } else {
          rowsHtml = items.map(makeStandardRow).join('');
        }

        const sampleToggleHtml = withSampleToggle ? `
          <label class="subgroup-sample-toggle">
            <input type="checkbox"
                   class="subgroup-sample-checkbox"
                   data-group="${groupName}"
                   data-subgroup="${subName}">
            Request Sample
          </label>
        ` : '';

        out += `
          <h3 class="subgroup-title">
            ${subName}
            ${sampleToggleHtml}
          </h3>
          <p class="subgroup-description">${subDesc}</p>
          <table class="menu-table">
            <colgroup>${standardColgroup}</colgroup>
            <thead>
              <tr>${buildStandardHeaderHtml()}</tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
        `;
      });

      return out;
    }

    /**
     * Build HTML for flat sections (Pre-Roll, Other).
     * These do not get subgroup-level sample toggles.
     */
    function renderFlatSection(groupName, items) {
      if (!items || !items.length) return '';

      const rowsHtml = items.map(makeStandardRow).join('');

      return `
        <h2 class="group-title">${groupName}</h2>
        <p class="group-description">${groupDescriptions[groupName] || ''}</p>
        <table class="menu-table">
          <colgroup>${standardColgroup}</colgroup>
          <thead>
            <tr>${buildStandardHeaderHtml()}</tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      `;
    }

    /**
     * Build a standard row for non-tincture items (with analytes).
     */
    function makeStandardRow(pkg) {
      const priceNum = Number(pkg.Price) || 0;
      const a = pkg.analytes || { totalTHC: 0, totalCBD: 0, totalTerpenes: 0 };

      return `
        <tr class="menu-row">
          <td class="item-name">${pkg.ItemName || ''}</td>
          <td class="item-category">${pkg.Type || ''}</td>
          <td>${pkg.Quantity || 0}</td>
          <td class="item-price" data-price="${priceNum.toFixed(2)}">$${priceNum.toFixed(2)}</td>
          <td class="item-thc">${a.totalTHC}</td>
          <td class="item-cbd">${a.totalCBD}</td>
          <td class="item-terps">${a.totalTerpenes}</td>
          <td>
            <input type="number"
                   min="0"
                   step="5"
                   inputmode="numeric"
                   pattern="\\d*"
                   class="item-input"
                   data-step="5">
          </td>
          <td class="item-total">$0.00</td>
        </tr>
      `;
    }

    /**
     * Build the standard table header row (with sortable columns and no sample column).
     */
    function buildStandardHeaderHtml() {
    const cols = [
    { key: 'item', label: 'Item' },
    { key: 'category', label: 'Category' },
    { key: 'qty', label: 'Avail. Qty' },
    { key: 'price', label: 'Price' },
    { key: 'thc', label: 'THC %' },
    { key: 'cbd', label: 'CBD %' },
    { key: 'terps', label: 'Terps %' },
    { key: null, label: 'Amount Wanted' },
    { key: null, label: 'Item Total' }
    ];


    return cols.map(col => {
    if (!col.key) return `<th>${col.label}</th>`;


    return `
    <th class="sortable"
    data-sort-col="${col.key}"
    data-sort-asc="">
    <span class="sort-label">${col.label}</span>
    <span class="sort-indicator">▲▼</span>
    </th>
    `;
    }).join('');
    }

    // =====================================
    // TOTALS & STEP ENFORCEMENT
    // =====================================

    /**
     * Enforce quantities as multiples of a given step (default 5).
     */
    function enforceStep(input) {
      const raw = input.value.trim();
      if (!raw) return;

      const step = parseInt(input.dataset.step || '5', 10) || 5;
      const n = parseInt(raw, 10);
      if (Number.isNaN(n) || n < 0) {
        input.value = '';
        return;
      }

      const rounded = Math.round(n / step) * step;
      input.value = rounded;
    }

    /**
     * Recalculate per-row item totals and overall running total.
     */
    function updateTotals() {
      let total = 0;
      const rows = document.querySelectorAll('#menu-data .menu-row');

      rows.forEach(row => {
        const input = row.querySelector('.item-input');
        const priceEl = row.querySelector('.item-price');
        const totalCell = row.querySelector('.item-total');

        if (!input || !priceEl || !totalCell) return;

        const qty = parseFloat(input.value) || 0;
        const price = parseFloat(priceEl.dataset.price) || 0;
        const lineTotal = qty * price;

        total += lineTotal;
        totalCell.textContent = `$${lineTotal.toFixed(2)}`;
      });

      document.getElementById('running-total').textContent =
        `Total: $${total.toFixed(2)}`;
    }

    // Table-local sort logic
    //****
    function sortTableByColumn(table, columnKey, th) {
    const tbody = table.querySelector('tbody');
    if (!tbody) return;


    const rows = Array.from(tbody.querySelectorAll('tr.menu-row'));
    if (!rows.length) return;


    const asc = th.dataset.sortAsc !== 'true';


    // Reset only THIS table's headers
    table.querySelectorAll('th.sortable').forEach(h => {
    h.dataset.sortAsc = '';
    h.querySelector('.sort-indicator').textContent = '▲▼';
    });


    th.dataset.sortAsc = asc ? 'true' : 'false';
    th.querySelector('.sort-indicator').textContent = asc ? '▲' : '▼';


    const dir = asc ? 1 : -1;


    rows.sort((a, b) => {
    let av, bv;


    switch (columnKey) {
    case 'item':
    av = a.querySelector('.item-name')?.textContent.toLowerCase() || '';
    bv = b.querySelector('.item-name')?.textContent.toLowerCase() || '';
    break;
    case 'category':
    av = a.querySelector('.item-category')?.textContent.toLowerCase() || '';
    bv = b.querySelector('.item-category')?.textContent.toLowerCase() || '';
    break;
    case 'qty':
    av = parseFloat(a.children[2].textContent) || 0;
    bv = parseFloat(b.children[2].textContent) || 0;
    break;
    case 'price':
    av = parseFloat(a.querySelector('.item-price')?.dataset.price) || 0;
    bv = parseFloat(b.querySelector('.item-price')?.dataset.price) || 0;
    break;
    case 'thc':
    av = parseFloat(a.querySelector('.item-thc')?.textContent) || 0;
    bv = parseFloat(b.querySelector('.item-thc')?.textContent) || 0;
    break;
    case 'cbd':
    av = parseFloat(a.querySelector('.item-cbd')?.textContent) || 0;
    bv = parseFloat(b.querySelector('.item-cbd')?.textContent) || 0;
    break;
    case 'terps':
    av = parseFloat(a.querySelector('.item-terps')?.textContent) || 0;
    bv = parseFloat(b.querySelector('.item-terps')?.textContent) || 0;
    break;
    default:
    return 0;
    }


    return (av > bv ? 1 : av < bv ? -1 : 0) * dir;
    });


    rows.forEach(r => tbody.appendChild(r));
    }

    // =====================================
    // ORDER BUILDERS (EMAIL BODY + JSON)
    // =====================================

    /**
     * Build an HTML table (as string) and total for the ordered items
     * (qty > 0). Used as the EmailJS email body snippet.
     */
    function buildOrderRowsAndTotalForEmail() {
      let rowsHtml = '';
      let total = 0;

      // -------------------------------
      // REAL ORDERED ITEMS
      // -------------------------------
      document.querySelectorAll('#menu-data .menu-row').forEach(row => {
        const input = row.querySelector('.item-input');
        const priceEl = row.querySelector('.item-price');
        const nameEl = row.querySelector('.item-name');

        if (!input || !priceEl || !nameEl) return;

        const qty = parseFloat(input.value) || 0;
        const price = parseFloat(priceEl.dataset.price) || 0;

        if (qty <= 0 || price <= 0) return;

        const lineTotal = qty * price;
        total += lineTotal;

        rowsHtml += `
          <tr>
            <td>${nameEl.textContent.trim()}</td>
            <td>${qty}</td>
            <td>$${price.toFixed(2)}</td>
            <td>$${lineTotal.toFixed(2)}</td>
          </tr>
        `;
      });

    // -------------------------------
    // SAMPLE REQUEST ROWS
    // -------------------------------
    const sampleRequests = collectSampleRequests();

    sampleRequests.forEach(name => {
      rowsHtml += `
        <tr style="background:#fff7cc;">
          <td>${name} (Sample Request)</td>
          <td>sample</td>
          <td>$0.00</td>
          <td>$0.00</td>
        </tr>
      `;
    });

    // -------------------------------
    // TOTAL ROW
    // -------------------------------
    rowsHtml += `
      <tr style="background:#f9f9f9;">
        <td colspan="3" style="text-align:right;"><strong>Total:</strong></td>
        <td><strong>$${total.toFixed(2)}</strong></td>
      </tr>
    `;

    return { rowsHtml, total };
  }

    /**
     * Collect which product types (subgroups) had Sample Request checked.
     * Returns array of clean names:
     *   ["Zen Drops", "Diamond Cut", "1g Cart", "2g Vape", ...]
     */
    function collectSampleRequests() {
      const samples = [];

      document.querySelectorAll('.subgroup-sample-checkbox:checked').forEach(cb => {
        const group = cb.dataset.group || "";
        const subgroup = cb.dataset.subgroup || "";
        if (!group || !subgroup) return;

        // Base name
        let name = subgroup;

        // Normalize carts & vapes: "1 gram"/"2 gram" → "1g"/"2g" and append group
        if (group === "Cart" || group === "Vape") {
          const lower = subgroup.toLowerCase();
          if (lower === "1 gram") {
            name = "1g";
          } else if (lower === "2 gram") {
            name = "2g";
          } else {
            name = subgroup;
          }
          name = `${name} ${group}`; // e.g., "1g Cart", "2g Vape"
        }

        // Tincture & Infused Pre-Rolls keep clean subgroup names:
        // "Zen Drops", "Diamond Cut", "Double Diamonds"

        samples.push(name);
      });

      return samples;
    }

    /**
     * Build a JSON-serializable order object for attachment.
     * Items are line-level; sampleRequests is a list of clean product strings.
     */
    function buildOrderObject() {
      const items = [];

      // Real ordered items
      document.querySelectorAll('#menu-data .menu-row').forEach(row => {
        const input = row.querySelector('.item-input');
        const priceEl = row.querySelector('.item-price');
        const nameEl = row.querySelector('.item-name');
        const categoryEl = row.querySelector('.item-category');

        if (!input || !priceEl || !nameEl) return;

        const qty = parseFloat(input.value) || 0;
        const price = parseFloat(priceEl.dataset.price) || 0;

        if (qty > 0) {
          items.push({
            product: nameEl.textContent.trim(),
            category: categoryEl ? categoryEl.textContent.trim() : '',
            quantity: qty,
            price: price
          });
        }
      });

      // SAMPLE REQUESTS → add virtual rows
      const sampleRequests = collectSampleRequests();
      sampleRequests.forEach(name => {
        items.push({
          product: name,
          category: "Sample Request",
          quantity: "sample request",
          price: 0
        });
      });

      return {
        name: document.getElementById('user-name').value.trim(),
        badge: document.getElementById('badge-number').value.trim(),
        dispensary: document.getElementById('dispensary-name').value.trim(),
        license: document.getElementById('delivery-license').value.trim(),
        email: document.getElementById('contact-email').value.trim(),
        notes: document.getElementById('special-notes').value.trim(),
        items,
        sampleRequests
      };
    }

    /**
     * Encode the order JSON as a data URI for EmailJS attachment.
     */
    function makeJsonAttachment(obj) {
      const json = JSON.stringify(obj, null, 2);
      const b64 = btoa(unescape(encodeURIComponent(json)));
      return `data:application/json;base64,${b64}`;
    }

    // =====================================
    // SUBMIT HANDLER
    // =====================================

    /**
     * Validate form, ensure at least one item ordered, then send via EmailJS.
     */
    function submitOrder() {
      const requiredIds = [
        'user-name',
        'badge-number',
        'dispensary-name',
        'delivery-license',
        'contact-email'
      ];

      for (const id of requiredIds) {
        const el = document.getElementById(id);
        if (!el || !el.value.trim()) {
          alert('Please fill out all required fields before submitting.');
          el && el.focus();
          return;
        }
      }

      const { rowsHtml, total } = buildOrderRowsAndTotalForEmail();
      if (total <= 0) {
        alert('Please enter at least one quantity before submitting.');
        return;
      }

      const orderObj = buildOrderObject();
      const attachment = makeJsonAttachment(orderObj);
      const sampleRequestsStr = (orderObj.sampleRequests || []).join(', ');

      emailjs.send('service_gkv3ioj', 'template_b8d47cn', {
        name: orderObj.name,
        badge: orderObj.badge,
        license: orderObj.license,
        dispensary: orderObj.dispensary,
        notes: orderObj.notes,
        reply_to: orderObj.email,
        order: rowsHtml,
        total: `$${total.toFixed(2)}`,
        raw_order_file: attachment,
        sample_requests: sampleRequestsStr
      })
      .then(() => {
        alert('Order submitted. Thank you!');
        window.location.reload();
      });
    }

    // =====================================
    // EVENT WIRING (DELEGATED LISTENERS)
    // =====================================

    // Handle clicks on sortable header cells
    document.getElementById('menu-data').addEventListener('click', function (e) {
    const th = e.target.closest('th.sortable');
    if (!th) return;

    const colKey = th.dataset.sortCol;
    if (!colKey) return;

    const table = th.closest('table.menu-table');
    if (!table) return;

    sortTableByColumn(table, colKey, th);
    });

    // Handle input changes on quantity fields (update totals live)
    document.getElementById('menu-data').addEventListener('input', function (e) {
      if (e.target.classList.contains('item-input')) {
        updateTotals();
      }
    });

    // Handle blur on quantity fields (enforce multiples of 5, then re-total)
    document.getElementById('menu-data').addEventListener('blur', function (e) {
      if (e.target.classList.contains('item-input')) {
        enforceStep(e.target);
        updateTotals();
      }
    }, true); // use capture to ensure blur is caught

    // Hook up submit button
    document.getElementById('submit-button').addEventListener('click', submitOrder);

    // =====================================
    // DISPENSARY & LICENSE AUTOCOMPLETE
    // =====================================

    const dispensaryInput   = document.getElementById('dispensary-name');
    const licenseInput      = document.getElementById('delivery-license');
    const businessHidden    = document.getElementById('business-name');
    const businessDisplay   = document.getElementById('business-name-display');

    const dispensarySuggestions = document.getElementById('dispensary-suggestions');
    const licenseSuggestions    = document.getElementById('license-suggestions');

    // -------------------------------------
    // Dispensary → fill license + business
    // -------------------------------------
    dispensaryInput.addEventListener('input', () => {
      const q = dispensaryInput.value.trim().toLowerCase();
      dispensarySuggestions.innerHTML = '';
      dispensarySuggestions.style.display = 'none';

      businessHidden.value = '';
      businessDisplay.textContent = '';
      licenseInput.value = '';

      if (q.length < 2) return;

      const matches = licenses.filter(l =>
        l.location.toLowerCase().includes(q)
      );

      dispensarySuggestions.style.display = matches.length ? 'block' : 'none';

      matches.forEach(l => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.textContent = l.location;

        div.addEventListener('click', () => {
          dispensaryInput.value = l.location;
          licenseInput.value = l.license;
          businessHidden.value = l.business;
          businessDisplay.textContent = l.business;
          dispensarySuggestions.innerHTML = '';
          dispensarySuggestions.style.display = 'none';
        });

        dispensarySuggestions.appendChild(div);
      });
    });

    // -------------------------------------
    // License → fill dispensary + business
    // -------------------------------------
    licenseInput.addEventListener('input', () => {
      const q = licenseInput.value.trim().toLowerCase();
      licenseSuggestions.innerHTML = '';
      licenseSuggestions.style.display = 'none';

      businessHidden.value = '';
      businessDisplay.textContent = '';
      dispensaryInput.value = '';

      if (q.length < 2) return;

      const matches = licenses.filter(l =>
        l.license.toLowerCase().includes(q)
      );

      licenseSuggestions.style.display = matches.length ? 'block' : 'none';

      matches.forEach(l => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.textContent = `${l.license} — ${l.location}`;

        div.addEventListener('click', () => {
          licenseInput.value = l.license;
          dispensaryInput.value = l.location;
          businessHidden.value = l.business;
          businessDisplay.textContent = l.business;
          licenseSuggestions.innerHTML = '';
          licenseSuggestions.style.display = 'none';
        });

        licenseSuggestions.appendChild(div);
      });
    });

    // -------------------------------------
    // Click-away handler (shared)
    // -------------------------------------
    document.addEventListener('click', e => {
      if (!e.target.closest('.autocomplete')) {
        dispensarySuggestions.innerHTML = '';
        licenseSuggestions.innerHTML = '';
        dispensarySuggestions.style.display = 'none';
        licenseSuggestions.style.display = 'none';
      }
    });

  // =====================================
  // IFRAME AUTO-RESIZE (postMessage)
  // =====================================
  (function enableIframeAutoResize() {
    const wrapper = document.getElementById('app-wrapper') || document.body;

    function sendHeight() {
      // Use wrapper height + a little padding for safety
      const height = Math.ceil(wrapper.scrollHeight + 40);

      // Send to parent (Squarespace page)
      window.parent.postMessage(
        { type: 'CERES_IFRAME_HEIGHT', height },
        '*'
      );
    }

    // Send at key times
    window.addEventListener('load', sendHeight);

    // ResizeObserver catches dynamic content changes (menu loads, tables render, etc.)
    if ('ResizeObserver' in window) {
      const ro = new ResizeObserver(() => sendHeight());
      ro.observe(wrapper);
    } else {
      // Fallback: periodic updates
      setInterval(sendHeight, 1000);
    }

    // Also fire after rendering (page updates DOM after fetch)
    const originalRender = window.renderMenuTables;
    if (typeof originalRender === 'function') {
      window.renderMenuTables = function () {
        const result = originalRender.apply(this, arguments);
        // Let the DOM paint first, then measure
        requestAnimationFrame(sendHeight);
        return result;
      };
    }
  })();

</script>
</body>
</html>
